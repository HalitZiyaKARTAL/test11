statfilelist() { local D="$1" O="$2" SI="$3" DI="$4" L="$5" PR="${6:-adb}" PO="${7:-8022}" C="${8:-0}"; [[ -z "$O" ]] && { echo "Usage: statfilelist <dir> <out> [src] [dst] [list] [proto] [port] [confirm]" >&2; return 1; }; _x() { if [[ -n "$1" ]]; then [[ "$PR" == "ssh" ]] && ssh -p "$PO" "$1" "$2" || adb -s "$1" shell "$2"; else eval "$2"; fi; }; local E=$(_x "$DI" "[ -e \"$O\" ] && echo 1"); if [[ "$E" == "1" ]]; then [[ "$((C&2))" -eq 0 ]] && { read -p "Overwrite '$O'? [y/N] " -n 1 -r; echo; [[ ! $REPLY =~ ^[Yy]$ ]] && return 1; }; else [[ "$((C&1))" -eq 0 ]] && { read -p "Create '$O'? [y/N] " -n 1 -r; echo; [[ ! $REPLY =~ ^[Yy]$ ]] && return 1; }; fi; local CMD="export LC_ALL=C.UTF-8; T=\$(mktemp); trap 'rm -f \$T' EXIT; $([[ -n "$L" ]] && echo "cat \"$L\"" || echo "find \"$D\" -maxdepth 1 -type f") | sort > \$T; TOT=\$(wc -l < \$T); echo \"Total: \$TOT\" >&2; echo '{\"data\":[\"'; cat \$T | tr '\n' '\0' | xargs -0 stat | awk -v M=\$TOT '{gsub(/\"/, \"\\\\\\\"\")} /^ *File: /{if(N++>0) printf \"\\\",\\n\\\"\"; if(N%1000==0) printf \"\\r\\033[1;33mStat: %d/%d\\033[0m\", N, M > \"/dev/stderr\"} {print}'; echo '\"], \"map\":{'; awk '{gsub(/\"/, \"\\\\\\\"\", \$0); printf \"\\\"%s\\\":%d,\\n\", \$0, NR-1}' \$T | sed '\$ s/,\$//'; echo '}}'"; if [[ "$SI" == "$DI" ]]; then _x "$SI" "$CMD > \"$O\""; else _x "$SI" "$CMD" | _x "$DI" "cat > \"$O\""; fi; echo -e "\nDone."; }
