{
SOURCE_DIR_DEFAULT="$HOME/storage/downloads/"; DEST_DIR_DEFAULT="/storage/9C33-6BBD/dosya taşıma/1. alan/asıl/Download/"

lister_formatter='{size=$5; split("B K M G T P",u," "); i=1; while(size>=1000&&i<7){size/=1000;i++} size_str=sprintf("%.2f%s",size,u[i]); filename=""; for(j=9; j<=NF; j++) filename=filename (j>9 ? " " : "") $j; printf "%-11s %s\n", size_str, filename}'
get_dir_stats() { local path="$1" folders=0 files=0; if [ -d "$path" ]; then folders=$(find "$path" -mindepth 1 -maxdepth 1 -type d | wc -l); files=$(find "$path" -mindepth 1 -maxdepth 1 -type f | wc -l); fi; echo "$folders $files"; }
interactive_lister() { local list_path="$SOURCE_DIR" list_head=10 list_tail_start=1; while true; do echo -e "\n\033[1;34m--- Interactive Directory Lister ---\033[0m"; echo -e "Current Settings: Path: \033[1;37m${list_path}\033[0m | Slice: \033[1;37m${list_tail_start}-${list_head}\033[0m largest files"; read -p "$(echo -e "\033[1;33mActions: (L)ist, (P)ath, (H)ead, (T)ail Start, (R)eset, (Q)uit > \033[0m")" -r choice; choice=${choice,,}; case "$choice" in l) echo -e "\nListing files for '${list_path}'..."; if ! [ -d "$list_path" ]; then echo -e "\033[1;31mError: Directory not found.\033[0m"; continue; fi; local tail_count=$((list_head - list_tail_start + 1)); if [ $tail_count -lt 1 ]; then echo -e "\033[1;31mError: Tail Start cannot be greater than Head.\033[0m"; continue; fi; ls -lS "${list_path}" | grep "^-" | head -n "$list_head" | tail -n "$tail_count" | awk "$lister_formatter" || echo "No files found or error in listing.";; p) read -p "Set path: (S)ource, (T)arget, or enter custom path > " -r path_choice; case "${path_choice,,}" in s) list_path="$SOURCE_DIR";; t) list_path="$DEST_DIR";; *) list_path="$path_choice";; esac;; h) read -p "Show top N largest files (Head) [current: $list_head]: " list_head;; t) read -p "Start from file rank (Tail Start) [current: $list_tail_start]: " list_tail_start;; r) list_path="$SOURCE_DIR"; list_head=10; list_tail_start=1; echo "Settings reset to defaults.";; q) return;; *) echo -e "\033[1;31mInvalid option.\033[0m";; esac; done; }
list_category() { local title=$1 color_code=$2; declare -n arr=$3; if [ ${#arr[@]} -gt 0 ]; then echo -e "\n\033[1;${color_code}m--- $title (${#arr[@]}) ---\033[0m"; for f in "${!arr[@]}"; do if [[ "$3" == "sync_pairs" ]]; then echo "  '${f}' -> '${arr[$f]}'"; else echo "  - $f"; fi; done; fi; }

run_analysis() {
    local SOURCE_DIR="${1%/}/"; local DEST_DIR="${2%/}/"; echo -e "\033[1;34m--- Analyzing Directories ---\033[0m"; echo -e "Source: \033[1;37m$SOURCE_DIR\033[0m"; echo -e "Dest:   \033[1;37m$DEST_DIR\033[0m"; mapfile -t SOURCE_FILES_TO_CHECK < <(find "$SOURCE_DIR" -maxdepth 1 -type f -printf "%f\n" 2>/dev/null || true); local TOTAL_TO_CHECK=${#SOURCE_FILES_TO_CHECK[@]}; declare -A sync_pairs not_found_list ambiguous_list; local unpaired_pass1=()

    echo -e "\n\033[1;36mPass 1: Checking for exact matches ($TOTAL_TO_CHECK files)...\033[0m"; for source_f in "${SOURCE_FILES_TO_CHECK[@]}"; do if [ -f "${DEST_DIR}${source_f}" ]; then sync_pairs["$source_f"]="$source_f"; echo -e "  - (${#sync_pairs[@]}/$TOTAL_TO_CHECK) \033[1;32mExact Match:\033[0m '${source_f}'"; else unpaired_pass1+=("$source_f"); fi; done; echo "Found ${#sync_pairs[@]} exact matches. ${#unpaired_pass1[@]} files remain."

    if [ ${#unpaired_pass1[@]} -gt 0 ]; then read -p "$(echo -e "\033[1;33mAction: Run (F)uzzy search, (S)kip, (I)nject code > \033[0m")" -n 1 -r choice; echo; choice=${choice,,}; case "$choice" in f) echo -e "\n\033[1;36mPass 2: Performing fuzzy search...\033[0m"; declare -A fuzzy_map; for f in "${unpaired_pass1[@]}"; do sanitized_f=$(echo "$f" | sed 's/[^a-zA-Z0-9]//g'); fuzzy_map["$sanitized_f"]="$f"; done; while IFS= read -r dest_f; do sanitized_dest=$(echo "$dest_f" | sed 's/[^a-zA-Z0-9]//g'); if [[ -n "${fuzzy_map[$sanitized_dest]}" ]]; then source_f="${fuzzy_map[$sanitized_dest]}"; source_size=$(stat -c %s "${SOURCE_DIR}${source_f}"); dest_size=$(stat -c %s "${DEST_DIR}${dest_f}"); if [[ "$source_size" == "$dest_size" ]]; then sync_pairs["$source_f"]="$dest_f"; echo -e "  - (${#sync_pairs[@]}/$TOTAL_TO_CHECK) \033[1;32mFuzzy Match:\033[0m '${source_f}' -> '${dest_f}'"; else ambiguous_list["$source_f"]=1; fi; fi; done < <(find "$DEST_DIR" -maxdepth 1 -type f -printf "%f\n" 2>/dev/null || true);; i) echo -e "\033[1;31mWARNING: Entering interactive shell. Type 'exit' to return.\033[0m"; bash;; *) echo "Skipping fuzzy search.";; esac; fi

    for f in "${SOURCE_FILES_TO_CHECK[@]}"; do if [[ -z "${sync_pairs[$f]}" && -z "${ambiguous_list[$f]}" ]]; then not_found_list["$f"]=1; fi; done

    echo -e "\n\033[1;35m--- Analysis Complete: Main Menu ---\033[0m"; while true; do read -p "$(echo -e "\033[1;33mAction? M:${#sync_pairs[@]} N:${#not_found_list[@]} | (D)irs (L)ist (R)sync (V)erify (S)ubfolders (Q)uit (H)elp > \033[0m")" -r choice; choice=${choice,,}; case "$choice" in d) interactive_lister;; l) list_category "Confirmed Pairs" "32" sync_pairs; list_category "Not Found" "31" not_found_list; list_category "Ambiguous" "33" ambiguous_list;; r) if [ ${#not_found_list[@]} -eq 0 ]; then echo "No 'Not Found' files to rsync."; else rsync -av --progress --files-from=<(printf "%s\n" "${!not_found_list[@]}") "$SOURCE_DIR" "$DEST_DIR"; fi;; v) if [ ${#sync_pairs[@]} -eq 0 ]; then echo "No matched pairs to verify."; elif ! command -v sha512sum &> /dev/null; then echo "Error: 'sha512sum' command not found."; else echo -e "\033[1;33mVerifying ${#sync_pairs[@]} pairs (SHA512)...\033[0m"; for f in "${!sync_pairs[@]}"; do echo -n "Verifying '$f'... "; H1=$(sha512sum "${SOURCE_DIR}$f" | cut -d' ' -f1); H2=$(sha512sum "${DEST_DIR}${sync_pairs[$f]}" | cut -d' ' -f1); if [[ "$H1" == "$H2" ]]; then echo -e "\033[1;32mOK\033[0m"; else echo -e "\033[1;31mFAIL\033[0m"; fi; done; echo "Verification complete."; fi;; s) mapfile -t subdirs < <( (find "$SOURCE_DIR" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" 2>/dev/null; find "$DEST_DIR" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" 2>/dev/null) | sed 's/^[ \t]*//;s/[ \t]*$//' | sort -u ); if [ ${#subdirs[@]} -eq 0 ]; then echo "No subfolders found."; else echo -e "\nCalculating content stats..."; local total_folders=${#subdirs[@]}; echo -e "\033[1;33mFormat (#/${total_folders}): Status, Contents (F:S-D, f:S-D), Name\033[0m"; i=1; for dir in "${subdirs[@]}"; do read src_folders src_files < <(get_dir_stats "${SOURCE_DIR}${dir}"); read dst_folders dst_files < <(get_dir_stats "${DEST_DIR}${dir}"); status=""; if [ -d "${SOURCE_DIR}${dir}" ] && [ -d "${DEST_DIR}${dir}" ]; then status="\033[1;32m[B]\033[0m"; elif [ -d "${SOURCE_DIR}${dir}" ]; then status="\033[1;33m[S]\033[0m"; else status="\033[1;36m[D]\033[0m"; fi; echo -e "($i/$total_folders) $status F:${src_folders}-${dst_folders} f:${src_files}-${dst_files} $dir"; ((i++)); done; read -p "Select #, type name, or (C)ancel: " sel; if [[ ${sel,,} != "c" && -n "$sel" ]]; then if [[ $sel =~ ^[0-9]+$ ]] && [ $sel -ge 1 ] && [ $sel -le ${#subdirs[@]} ]; then sel="${subdirs[$((sel-1))]}"; fi; echo -e "\n\033[1;31m--- Descending into: '$sel' ---\033[0m\n"; run_analysis "${SOURCE_DIR}${sel}" "${DEST_DIR}${sel}"; echo -e "\n\033[1;31m--- Returning to parent menu ---\033[0m"; fi; fi;; q) echo "Exiting current menu."; return;; h) echo -e "  (D)irs\t- Interactive directory lister."; echo -e "  (L)ist\t- Show files by category."; echo -e "  (R)sync\t- Copy 'Not Found' files."; echo -e "  (V)erify\t- SHA512 check matched pairs."; echo -e "  (S)ubfolders\t- Analyze a subfolder."; echo -e "  (Q)uit\t- Exit current menu.";; *) echo -e "\033[1;31mInvalid option. Press (H) for help.\033[0m";; esac; done
}

run_analysis "$SOURCE_DIR_DEFAULT" "$DEST_DIR_DEFAULT"
echo -e "\n\033[1;32mScript finished.\033[0m"

}
