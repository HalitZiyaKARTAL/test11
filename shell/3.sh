richcopy() { local S="$1" D="$2" I="$3" P="${4:-8022}" L="$5" PW="$6" SAFE="${7:-0}" CF="${8:-0}" VI="${9:-0}" BUF="${10:-5}" PT="${11:-0}" HD="${12}" TL="${13}"; [ "$#" -lt 2 ] && { echo -e "\033[1;33mUsage: richcopy <SRC> <DEST> [IP] [PORT] [LIST] [PASS] [SAFE] [CREATE] [VERIFY_INT] [BUF_SIZE] [PATCH] [HEAD] [TAIL]\n\nNote: For statcomp use https://raw.githubusercontent.com/halitziyakartal/test11/main/shell/2.sh\033[0m"; return 1; }; unset T E N ID FC SC SF CHK; local T=0 E=0 N=0 ID="N" FC=0 SF=0 CHK=0; local SC="ssh -p $P" WL=".work_list"; local LAST_UI_TIME=0 UI_DELAY=30000 NOW=0; local UI_REF=100; ((VI > 0)) && UI_REF=$VI; trap 'echo -e "\n\033[1;31m❌ Interrupted.\033[0m"; rm "$WL" ".rc_remote_list.txt" 2>/dev/null; return 1' INT; echo -e "\n\033[1;34m--- ANALYZING ---\033[0m"; [ -n "$PW" ] && command -v sshpass >/dev/null && SC="sshpass -p '$PW' ssh -p $P"; if [ -n "$I" ]; then ID=$(adb -s $I shell "[ -d '$S' ] && echo Y"); else [ -d "$S" ] && ID="Y"; fi; apply_filter() { local cmd="cat"; [ -n "$HD" ] && cmd="$cmd | head -n $HD"; [ -n "$TL" ] && cmd="$cmd | tail -n $TL"; eval "$cmd"; }; if [ -n "$L" ]; then if [ ! -f "$L" ]; then if [ -n "$I" ] && [ "$(adb -s $I shell "[ -f '$L' ] && echo Y")" == "Y" ]; then echo "⬇️ Fetching remote list..."; adb -s $I pull "$L" ".rc_remote_list.txt" >/dev/null; L=".rc_remote_list.txt"; else echo "❌ List missing: $L"; return 1; fi; fi; local RAW_T=$(awk 'END {print NR}' "$L"); cat "$L" | apply_filter > "$WL"; sed -i 's/\r$//' "$WL"; echo "" >> "$WL"; local LIST_T=$(grep -cve '^\s*$' "$WL"); print_bar() { echo -ne "List: $LIST_T/$RAW_T | Total: \033[1;36m$SF/$CHK\033[0m | Exists: \033[1;33m$E\033[0m | New: \033[1;32m$((SF-E))\033[0m\r"; }; while read -r f; do [ -z "$f" ] && continue; ((CHK++)); local EXISTS=0; if [[ "$f" == *.* ]]; then EXISTS=1; elif [ -n "$I" ]; then [ "$(adb -s $I shell "[ -d '$S/$f' ] && echo Y")" == "Y" ] && EXISTS=1; else [ -d "$S/$f" ] && EXISTS=1; fi; if ((EXISTS)); then ((SF++)); [ -e "$D/$f" ] && ((E++)); fi; NOW=${EPOCHREALTIME/./}; if (( NOW - LAST_UI_TIME >= UI_DELAY )); then print_bar; LAST_UI_TIME=$NOW; fi; done < "$WL"; print_bar; echo ""; T=$SF; elif [ -n "$I" ]; then if [ "$ID" == "Y" ]; then local RL=$(adb -s $I shell "cd '$S' && find . -type f" | apply_filter); T=$(echo "$RL" | wc -l); E=$(echo "$RL" | while read -r f; do [ -e "$D/${f#./}" ] && echo 1; done | wc -l); else T=1; [ -e "$D/$(basename "$S")" ] && E=1 || E=0; fi; echo -e "Total: $T | Exists: \033[1;33m$E\033[0m | New: \033[1;32m$((T-E))\033[0m"; else if [ "$ID" == "Y" ]; then T=$(find "$S" -type f | apply_filter | wc -l); E="?"; else T=1; [ -e "$D/$(basename "$S")" ] && E=1 || E=0; fi; echo -e "Total: $T | Exists: \033[1;33m$E\033[0m | New: \033[1;32m$((T-E))\033[0m"; fi; local ASK=1; if [[ "$SAFE" == "y" || "$SAFE" == "Y" ]]; then ASK=0; elif [[ "$SAFE" =~ ^[0-9]+$ ]] && ((SAFE > 0 && T <= SAFE)); then ASK=0; fi; if ((ASK)); then read -p "Proceed? [y/N] " c; [[ "$c" != "y" ]] && rm "$WL" ".rc_remote_list.txt" 2>/dev/null && return 1; fi; if [ ! -d "$D" ]; then if [[ "$CF" != "y" && "$CF" != "Y" ]]; then read -p "Create dest? [y/N] " c; [[ "$c" != "y" ]] && rm "$WL" ".rc_remote_list.txt" 2>/dev/null && return 1; fi; mkdir -p "$D"; fi; local TIMESTAMP=$(date +"%Y%m%d%H%M%S"); local LOG="/storage/emulated/0/Download/richcopy_log_${TIMESTAMP}.txt"; > "$LOG"; echo "Log: $LOG"; if [[ "$PT" != "y" && "$PT" != "Y" && "$PT" != "metadata" && "$PT" != "patch" ]]; then echo "[1/2] Syncing..."; if [ -z "$I" ]; then if [ "$ID" == "Y" ]; then cp -av "${S%/}/." "$D/"; else cp -av "$S" "$D/"; fi; else local CMD=("rsync" "-rh" "--info=progress2" "--no-times" "-s" "-e" "$SC"); if [ "$E" != "?" ] && ((E > 0 && ASK == 1)); then read -p "Overwrite $E existing files? [y/N] " w; [[ "$w" != "y" ]] && CMD+=("--ignore-existing"); fi; if [ -n "$L" ]; then "${CMD[@]}" --files-from="$WL" "$I:$S/" "$D/"; elif [ "$ID" == "Y" ]; then "${CMD[@]}" "$I:${S%/}/" "$D/"; else "${CMD[@]}" "$I:$S" "$D/"; fi; fi; else echo "⚠️ Patch Mode: Skipping Data Sync."; fi; echo "[2/2] Metadata (SSH Conveyor)..."; local PREV_HEIGHT=0; local COLS=$(tput cols); update_dashboard() { local START_LINE=$(grep -n "^----------------" "$LOG" | tail -n "$BUF" | head -n 1 | cut -d: -f1); [ -z "$START_LINE" ] && START_LINE=1; local DASHBOARD=$(tail -n "+$START_LINE" "$LOG"); local NEW_HEIGHT=0; while IFS= read -r line; do local LEN=${#line}; if ((LEN == 0)); then ((NEW_HEIGHT++)); else ((NEW_HEIGHT += (LEN + COLS - 1) / COLS)); fi; done <<< "$DASHBOARD"; ((PREV_HEIGHT > 0)) && echo -ne "\033[${PREV_HEIGHT}A"; echo -ne "\033[0J"; echo "$DASHBOARD"; PREV_HEIGHT=$NEW_HEIGHT; }; process() { local L_CNT=0 LAST_P="" LAST_F="" LAST_VERIFIED=0; run_verify() { echo "---------------------------------------------------" >> "$LOG"; echo "#$1: $2" >> "$LOG"; if [ -n "$I" ]; then if [ "$ID" == "Y" ] || [ -n "$L" ]; then statcomp "$S/${2#./}" "$3" "$I" "127.0.0.1" < /dev/null >> "$LOG"; else statcomp "$S" "$3" "$I" "127.0.0.1" < /dev/null >> "$LOG"; fi; else statcomp "$S/${2#./}" "$3" < /dev/null >> "$LOG"; fi; update_dashboard; }; while IFS='|' read -r p a m || [ -n "$p" ]; do [ -z "$p" ] && continue; m="${m%$'\r'}"; a="${a%$'\r'}"; f="$D/${p#./}"; [[ -e "$f" && "$m" == *"20"* ]] && { touch -a -d "$a" "$f"; touch -m -d "$m" "$f"; }; ((L_CNT++)); NOW=${EPOCHREALTIME/./}; if (( NOW - LAST_UI_TIME >= UI_DELAY )); then echo -ne "\rProcessed: $L_CNT / $T"; LAST_UI_TIME=$NOW; fi; LAST_P="$p"; LAST_F="$f"; if ((VI > 0 && (L_CNT == 1 || L_CNT % VI == 0))); then run_verify "$L_CNT" "$p" "$f"; LAST_VERIFIED=$L_CNT; fi; done; if ((VI > 0 && L_CNT > 0 && L_CNT != LAST_VERIFIED)); then run_verify "$L_CNT (LAST)" "$LAST_P" "$LAST_F"; fi; echo -ne "\rProcessed: $L_CNT / $T"; echo "COUNT=$L_CNT" >> "$LOG"; }; if [ -z "$I" ]; then if [[ "$PT" == "y" || "$PT" == "Y" ]]; then find "$S" -printf "%P|%x|%y\n" | apply_filter | process; fi; elif [ -n "$L" ]; then local R_TMP="/storage/emulated/0/Download/rc_list_${TIMESTAMP}.txt"; adb -s $I push "$WL" "$R_TMP" >/dev/null; $SC $I "cd '$S' && while read f; do find \"\$f\" -exec stat -c '%n|%x|%y' {} + || true; done < '$R_TMP'; rm '$R_TMP'" | process; elif [ "$ID" == "Y" ]; then local SR=$(dirname "${S%/}"); local TG=$(basename "${S%/}"); $SC $I "cd '$SR' && find '$TG' -exec stat -c '%n|%x|%y' {} +" | apply_filter | process; else $SC $I "stat -c '%n|%x|%y' '$S'" | apply_filter | process; fi; local FINAL_COUNT=$(grep "COUNT=" "$LOG" | tail -n 1 | cut -d= -f2); echo -e "\n✅ Done. Processed $FINAL_COUNT items."; trap - INT; [ -f "$WL" ] && rm "$WL" ".rc_remote_list.txt" 2>/dev/null; };richcopy;
