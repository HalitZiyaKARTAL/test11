 richcopy() {     local S="$1" D="$2" I="$3" P="${4:-8022}" L="$5" PW="$6" SAFE="${7:-0}" CF="${8:-0}" VI="${9:-0}" BUF="${10:-5}" PT="${11:-0}" HD="${12}" TL="${13}";     [ "$#" -lt 2 ] && { echo -e "\033[1;33mUsage: richcopy <SRC> <DEST> [IP] [PORT] [LIST] [PASS] [SAFE] [CREATE] [VERIFY_INT] [BUF_SIZE] [PATCH] [HEAD] [TAIL]\033[0m"; return 1; };
    echo -e "\n\033[1;34m--- ANALYZING ---\033[0m";     local T=0 E=0 N=0 ID="N" FC=0;     if [ -n "$I" ]; then ID=$(adb -s $I shell "[ -d '$S' ] && echo Y"); else [ -d "$S" ] && ID="Y"; fi;     apply_filter(){ if [ -n "$HD" ];then head -n "$HD";else cat;fi|if [ -n "$TL" ];then tail -n "$TL";else cat;fi; };      if [ -n "$L" ]; then         [ ! -f "$L" ] && { echo "❌ List missing"; return 1; };         local WL=".work_list"; cat "$L" | apply_filter > "$WL"; T=$(wc -l <"$WL");         while read -r f; do [ -e "$D/$f" ] && ((E++)); [[ "$f" != *.* ]] && [ "$(adb -s $I shell "[ -d '$S/$f' ] && echo Y")" == "Y" ] && ((FC++)); done < "$WL";         [ "$FC" -gt 0 ] && echo -e "\033[1;33m⚠️  List contains $FC folders.\033[0m";     elif [ -n "$I" ]; then         if [ "$ID" == "Y" ]; then local RL=$(adb -s $I shell "cd '$S' && find . -type f" | apply_filter); T=$(echo "$RL" | wc -l); E=$(echo "$RL" | while read -r f; do [ -e "$D/${f#./}" ] && echo 1; done | wc -l); else T=1; [ -e "$D/$(basename "$S")" ] && E=1 || E=0; fi;     else         if [ "$ID" == "Y" ]; then T=$(find "$S" -type f | apply_filter | wc -l); E="?"; else T=1; [ -e "$D/$(basename "$S")" ] && E=1 || E=0; fi;     fi;     if [ "$E" == "?" ]; then N="?"; else N=$((T-E)); fi;     echo -e "Total: $T | Exists: \033[1;33m$E\033[0m | New: \033[1;32m$N\033[0m";      local ASK=1;     if [[ "$SAFE" == "y" || "$SAFE" == "Y" ]]; then ASK=0; elif [[ "$SAFE" =~ ^[0-9]+$ ]] && [ "$SAFE" -gt 0 ] && [ "$T" -le "$SAFE" ]; then ASK=0; fi;     if [ "$ASK" -eq 1 ]; then read -p "Proceed? [y/N] " c; [[ "$c" != "y" ]] && rm "$WL" 2>/dev/null && return 1; fi;     if [ ! -d "$D" ]; then if [[ "$CF" != "y" && "$CF" != "Y" ]]; then read -p "Create dest? [y/N] " c; [[ "$c" != "y" ]] && rm "$WL" 2>/dev/null && return 1; fi; mkdir -p "$D"; fi;
    local TIMESTAMP=$(date +"%Y%m%d%H%M%S"); local LOG="/storage/emulated/0/Download/richcopy_log_${TIMESTAMP}.txt"; > "$LOG"; echo "Log: $LOG";     local SC="ssh -p $P"; [ -n "$PW" ] && command -v sshpass >/dev/null && SC="sshpass -p '$PW' ssh -p $P";      if [[ "$PT" != "y" && "$PT" != "Y" && "$PT" != "metadata" && "$PT" != "patch" ]]; then         echo "[1/2] Syncing...";         local CMD=("rsync" "-rh" "--info=progress2" "--no-times" "-s" "-e" "$SC");         if [ "$E" != "?" ] && [ "$E" -gt 0 ] && [ "$ASK" -eq 1 ]; then read -p "Overwrite $E existing files? [y/N] " w; [[ "$w" != "y" ]] && CMD+=("--ignore-existing"); fi;         if [ -n "$L" ]; then "${CMD[@]}" --files-from="$WL" "$I:$S/" "$D/"; elif [ "$ID" == "Y" ]; then "${CMD[@]}" "$I:${S%/}/" "$D/"; else "${CMD[@]}" "$I:$S" "$D/"; fi;     else echo "⚠️ Patch Mode: Skipping Data Sync."; fi;      echo "[2/2] Metadata (SSH Conveyor)...";     local PREV_HEIGHT=0; local COLS=$(tput cols);      update_dashboard() {
        local START_LINE=$(grep -n "^----------------" "$LOG" | tail -n "$BUF" | head -n 1 | cut -d: -f1);         [ -z "$START_LINE" ] && START_LINE=1;                  local DASHBOARD=$(tail -n "+$START_LINE" "$LOG");
        local NEW_HEIGHT=0;         while IFS= read -r line; do             local LEN=${#line};             if [ "$LEN" -eq 0 ]; then ((NEW_HEIGHT++)); else                 local LINES_WRAPPED=$(( (LEN + COLS - 1) / COLS ));                 NEW_HEIGHT=$((NEW_HEIGHT + LINES_WRAPPED));             fi
        done <<< "$DASHBOARD";
        if [ "$PREV_HEIGHT" -gt 0 ]; then echo -ne "\033[${PREV_HEIGHT}A"; fi;         echo -ne "\033[0J";
        echo "$DASHBOARD";         PREV_HEIGHT=$NEW_HEIGHT;     };      process() {         local L_CNT=0;         while IFS='|' read -r p a m; do             m="${m%$'\r'}"; a="${a%$'\r'}";             f="$D/${p#./}";             [[ -e "$f" && "$m" == *"20"* ]] && { touch -a -d "$a" "$f"; touch -m -d "$m" "$f"; };             ((L_CNT++));             if [[ "$VI" -gt 0 && $((L_CNT == 1 || L_CNT % VI == 0)) -eq 1 ]]; then                 echo "---------------------------------------------------" >> "$LOG";                 echo "#$L_CNT: $p" >> "$LOG";                 if [ -n "$I" ]; then                     if [ "$ID" == "Y" ] || [ -n "$L" ]; then statcomp "$S/${p#./}" "$f" "$I" "127.0.0.1" >> "$LOG";                     else statcomp "$S" "$f" "$I" "127.0.0.1" >> "$LOG"; fi;                 else statcomp "$S/${p#./}" "$f" >> "$LOG"; fi;                 update_dashboard;             fi;         done;         echo "COUNT=$L_CNT" >> "$LOG";     };      if [ -z "$I" ]; then         if [[ "$PT" == "y" || "$PT" == "Y" ]]; then find "$S" -printf "%P|%x|%y\n" | apply_filter | process; fi;     elif [ -n "$L" ]; then         local R_TMP="/storage/emulated/0/Download/rc_list_${TIMESTAMP}.txt";         local SCP_CMD="scp -P $P"; [ -n "$PW" ] && command -v sshpass >/dev/null && SCP_CMD="sshpass -p '$PW' scp -P $P";         $SCP_CMD "$WL" "$I:$R_TMP" >/dev/null;         $SC $I "cd '$S' && while read f; do find \"\$f\" -exec stat -c '%n|%x|%y' {} +; done < '$R_TMP'" | apply_filter | process;         $SC $I "rm '$R_TMP'";     elif [ "$ID" == "Y" ]; then         local SR=$(dirname "${S%/}"); local TG=$(basename "${S%/}");         $SC $I "cd '$SR' && find '$TG' -exec stat -c '%n|%x|%y' {} +" | apply_filter | process;     else         $SC $I "stat -c '%n|%x|%y' '$S'" | apply_filter | process;     fi;      local FINAL_COUNT=$(grep "COUNT=" "$LOG" | tail -n 1 | cut -d= -f2);     echo -e "\n✅ Done. Processed $FINAL_COUNT items.";     [ -f "$WL" ] && rm "$WL"; };richcopy;
