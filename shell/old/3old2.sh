richcopy(){ local S="$1" D="$2" I="$3" P="${4:-8022}" L="$5" PW="$6" SAFE="${7:-0}" CF="${8:-0}";[ "$#" -lt 2 ]&&{ echo -e "\033[1;33mUsage: richcopy <SRC> <DEST> [IP (Remote SSH+ADB)] [PORT] [LIST] [PASS] [SAFE] [CREATE]\033[0m";return 1;};echo -e "\n\033[1;34m--- ANALYZING ---\033[0m";local T=0 E=0 N=0 ID="N" FC=0;if [ -n "$I" ];then ID=$(adb -s $I shell "[ -d '$S' ] && echo Y");else [ -d "$S" ]&&ID="Y";fi;if [ -n "$L" ];then [ ! -f "$L" ]&&{ echo "❌ List missing";return 1;};T=$(wc -l <"$L");while read -r f;do [ -e "$D/$f" ]&&((E++));if [[ "$f" != *.* ]];then if [ "$(adb -s $I shell "[ -d '$S/$f' ] && echo Y")" == "Y" ];then ((FC++));fi;fi;done<"$L";[ "$FC" -gt 0 ]&&echo -e "\033[1;33m⚠️  List contains $FC folders.\033[0m";elif [ -n "$I" ];then if [ "$ID" == "Y" ];then local RL=$(adb -s $I shell "cd '$S' && find . -type f");T=$(echo "$RL"|wc -l);E=$(echo "$RL"|while read -r f;do [ -e "$D/${f#./}" ]&&echo 1;done|wc -l);else T=1;[ -e "$D/$(basename "$S")" ]&&E=1||E=0;fi;else if [ "$ID" == "Y" ];then T=$(find "$S" -type f|wc -l);E="?";else T=1;[ -e "$D/$(basename "$S")" ]&&E=1||E=0;fi;fi;if [ "$E" == "?" ];then N="?";else N=$((T-E));fi;echo -e "Total: $T | Exists: \033[1;33m$E\033[0m | New: \033[1;32m$N\033[0m";local ASK=1;if [[ "$SAFE" == "y" || "$SAFE" == "Y" ]];then ASK=0;elif [[ "$SAFE" =~ ^[0-9]+$ ]]&&[ "$SAFE" -gt 0 ]&&[ "$T" -le "$SAFE" ];then ASK=0;fi;if [ "$ASK" -eq 1 ];then read -p "Proceed? [y/N] " c;[[ "$c" != "y" ]]&&return 1;fi;if [ ! -d "$D" ];then if [[ "$CF" == "y" || "$CF" == "Y" ]];then echo "⚠️ Creating dest: $D";else read -p "Create dest? [y/N] " c;[[ "$c" != "y" ]]&&return 1;fi;mkdir -p "$D";fi;local CMD=("rsync" "-rh" "--info=progress2" "--no-times" "-s");if [ -n "$I" ];then local SC="ssh -p $P";[ -n "$PW" ]&&command -v sshpass >/dev/null&&SC="sshpass -p '$PW' ssh -p $P";CMD+=("-e" "$SC");fi;if [ "$E" != "?" ]&&[ "$E" -gt 0 ]&&[ "$ASK" -eq 1 ];then read -p "Overwrite $E existing files? [y/N] " w;[[ "$w" != "y" ]]&&CMD+=("--ignore-existing");fi;echo "[1/2] Syncing...";if [ -z "$I" ];then if [ "$ID" == "Y" ];then cp -av "${S%/}/." "$D/";else cp -av "$S" "$D/";fi;echo "✅ Done.";return 0;fi;if [ -n "$L" ];then "${CMD[@]}" --files-from="$L" "$I:$S/" "$D/";adb -s $I push "$L" /data/local/tmp/list.txt >/dev/null;adb -s $I shell "cd '$S' && while read f; do find \"\$f\" -exec stat -c '%n|%x|%y' {} +; done < /data/local/tmp/list.txt"|while IFS='|' read -r p a m;do m="${m%$'\r'}";f="$D/${p#./}";[[ -e "$f" && "$m" == *"20"* ]]&&{ touch -a -d "$a" "$f";touch -m -d "$m" "$f";};done;elif [ "$ID" == "Y" ];then local CL="${S%/}";"${CMD[@]}" "$I:$CL" "$D/";local SR=$(dirname "$CL");local TG=$(basename "$CL");adb -s $I shell "cd '$SR' && find '$TG' -exec stat -c '%n|%x|%y' {} +"|while IFS='|' read -r p a m;do m="${m%$'\r'}";f="$D/$p";[[ -e "$f" && "$m" == *"20"* ]]&&{ touch -a -d "$a" "$f";touch -m -d "$m" "$f";};done;else "${CMD[@]}" "$I:$S" "$D/";t=$(adb -s $I shell "stat -c '%x|%y' '$S'");a="${t%%|*}";m="${t#*|}";m="${m%$'\r'}";f="$D/$(basename "$S")";[[ -e "$f" && "$m" == *"20"* ]]&&{ touch -a -d "$a" "$f";touch -m -d "$m" "$f";};fi;echo "✅ Done.";}
