var configuration={dataset_text:"emma\nolivia\nava\nisabella\nsophia\ncharlotte\nmia\namelia\nharper\nevelyn\nabigail\nemily\nella\nelizabeth\ncamila\nluna\nsofia\navery\nmila\naria",embedding_dim:16,num_heads:4,num_layers:1,block_size:8,max_steps:500,learning_rate:1e-2,temperature:0.5,linearly_separated_step_samples:10,logarithmically_separated_step_samples:10,output_head_of_all_steps:10,output_tail_of_all_steps:5,print_me_after_run_loss_graph_array:[]};((C)=>{let G=C.print_me_after_run_loss_graph_array;G.push([]);let LH=G[G.length-1];let LG=new Set();for(let i=0;i<C.output_head_of_all_steps;i++)LG.add(i);for(let i=0;i<C.output_tail_of_all_steps;i++)LG.add(C.max_steps-1-i);for(let i=0;i<C.linearly_separated_step_samples;i++)LG.add(Math.floor(i*C.max_steps/C.linearly_separated_step_samples));for(let i=0;i<C.logarithmically_separated_step_samples;i++)LG.add(Math.floor(Math.pow(C.max_steps,i/(C.logarithmically_separated_step_samples-1)))-1);let RN=()=>Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random()),docs=C.dataset_text.trim().split('\n').map(x=>x.trim()).filter(x=>x);for(let i=docs.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[docs[i],docs[j]]=[docs[j],docs[i]]}console.log(`num docs: ${docs.length}`);let U=[...new Set(docs.join(''))].sort(),ST=c=>U.indexOf(c),IT=i=>U[i],VS=U.length+1,BOS=VS-1;console.log(`vocab size: ${VS}`);let V=(d,c=[])=>{let n={d,g:0,c,op:()=>{},mt:0,vt:0};n.a=o=>{o=o.d!=null?o:V(o);let r=V(n.d+o.d,[n,o]);r.op=()=>{n.g+=r.g;o.g+=r.g};return r};n.m=o=>{o=o.d!=null?o:V(o);let r=V(n.d*o.d,[n,o]);r.op=()=>{n.g+=o.d*r.g;o.g+=n.d*r.g};return r};n.p=e=>{let r=V(n.d**e,[n]);r.op=()=>{n.g+=e*n.d**(e-1)*r.g};return r};n.l=()=>{let r=V(Math.log(n.d),[n]);r.op=()=>{n.g+=r.g/n.d};return r};n.e=()=>{let r=V(Math.exp(n.d),[n]);r.op=()=>{n.g+=r.d*r.g};return r};n.r=()=>{let r=V(n.d<0?0:n.d,[n]);r.op=()=>{n.g+=(n.d>0)*r.g};return r};return n},P=[],M=(r,c,s=0.02)=>Array(r).fill().map(()=>Array(c).fill().map(()=>(P.push(v=V(s?RN()*s:0))&&v))),DT=(x,w)=>w.map(r=>r.reduce((a,b,i)=>a.a(b.m(x[i])),V(0))),RM=x=>x.map(v=>v.m(x.reduce((a,b)=>a.a(b.p(2)),V(0)).m(x.length**-1).a(1e-5).p(-.5))),SM=x=>{let m=x.reduce((a,b)=>a>b.d?a:b.d,-1e9),e=x.map(v=>v.a(-m).e()),s=e.reduce((a,b)=>a.a(b),V(0));return e.map(v=>v.m(s.p(-1)))},W={te:M(VS,C.embedding_dim),pe:M(C.block_size,C.embedding_dim),lm:M(VS,C.embedding_dim),l:[]};for(let i=0;i<C.num_layers;i++)W.l.push({q:M(C.embedding_dim,C.embedding_dim),k:M(C.embedding_dim,C.embedding_dim),v:M(C.embedding_dim,C.embedding_dim),o:M(C.embedding_dim,C.embedding_dim,0),f1:M(4*C.embedding_dim,C.embedding_dim),f2:M(C.embedding_dim,4*C.embedding_dim,0)});console.log(`num params: ${P.length}`);let GPT=(t,p,k,v)=>{let x=RM(W.te[t].map((z,i)=>z.a(W.pe[p][i])));for(let i=0;i<C.num_layers;i++){let L=W.l[i],r1=x;x=RM(x);let q=DT(x,L.q),K=DT(x,L.k),Val=DT(x,L.v),hd=C.embedding_dim/C.num_heads,att=[];k[i].push(K);v[i].push(Val);for(let h=0;h<C.num_heads;h++){let s=h*hd,sc=k[i].map(kp=>kp.slice(s,s+hd).reduce((a,b,j)=>a.a(b.m(q[s+j])),V(0)).m(hd**-.5));SM(sc).map((w,idx)=>v[i][idx].slice(s,s+hd).map((u,j)=>att[s+j]=(att[s+j]||V(0)).a(u.m(w))))}x=DT(att,L.o).map((u,j)=>u.a(r1[j]));r1=x;x=RM(x);x=DT(DT(x,L.f1).map(u=>u.r().p(2)),L.f2).map((u,j)=>u.a(r1[j]))}return DT(x,W.lm)};for(let s=0;s<C.max_steps;s++){let doc=docs[s%docs.length],tok=[BOS,...doc.split('').map(ST),BOS],n=Math.min(C.block_size,tok.length-1),ks=W.l.map(()=>[]),vs=W.l.map(()=>[]),loss=V(0);for(let i=0;i<n;i++)loss=loss.a(SM(GPT(tok[i],i,ks,vs))[tok[i+1]].l().m(-1));let avg=loss.m(1/n);LH.push(avg.d);let BK=n=>{let o=[],s=new Set(),f=x=>{if(!s.has(x)){s.add(x);(x.c||[]).map(f);o.push(x)}};f(n);n.g=1;o.reverse().map(x=>x.op())};P.map(p=>p.g=0);BK(avg);let lr=C.learning_rate*0.5*(1+Math.cos(Math.PI*s/C.max_steps));P.map(p=>{p.mt=.9*p.mt+.1*p.g;p.vt=.95*p.vt+.05*p.g**2;let mh=p.mt/(1-.9**(s+1)),vh=p.vt/(1-.95**(s+1));p.d-=lr*mh/(Math.sqrt(vh)+1e-8)});if(LG.has(s))console.log(`step ${String(s+1).padStart(4)} / ${String(C.max_steps).padStart(4)} | loss ${avg.d.toFixed(4)}`)}console.log("\n--- inference ---");for(let i=0;i<20;i++){let ks=W.l.map(()=>[]),vs=W.l.map(()=>[]),t=BOS,out="";for(let j=0;j<C.block_size;j++){let lg=GPT(t,j,ks,vs).map(x=>x.m(1/C.temperature)),pr=SM(lg),r=Math.random(),acc=0;for(let z=0;z<VS;z++)if((acc+=pr[z].d)>=r){t=z;break}if(t==BOS)break;out+=IT(t)}console.log(`sample ${String(i+1).padStart(2)}: ${out}`)}})(configuration);
