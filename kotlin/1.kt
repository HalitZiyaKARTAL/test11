package a.htmlapprealizer;import android.app.*;import android.os.*;import android.view.*;import android.webkit.*;import android.widget.*;import android.text.*;import android.text.style.*;import android.graphics.*;import org.json.*;import java.util.*;import java.lang.reflect.*;class master:Activity(){val H=ArrayList<Any?>();val L=Array(3){HashSet<String>()};val D=HashSet<String>();lateinit var w:WebView;lateinit var b:Button;var m=0;var s=true;var A=false;var NET=false;var PW="";val P by lazy{getSharedPreferences("Z",0)};fun S(k:String,v:Any)=with(P.edit()){if(v is Boolean)putBoolean(k,v)else putString(k,v.toString());apply()};override fun onCreate(k:Bundle?){super.onCreate(k);H.add(this);(0..2).forEach{i->L[i].addAll(P.getString("$i","")!!.split(","))};m=P.getInt("M",0);s=P.getBoolean("S",true);NET=P.getBoolean("N",false);PW=P.getString("W","")!!;D.addAll(P.getString("D","")!!.split(","));val f=FrameLayout(this);b=Button(this).apply{text="âš™";setTextColor(-1);setBackgroundColor(0x99000000.toInt());layoutParams=FrameLayout.LayoutParams(120,120,53);setOnClickListener{E()}};w=WebView(this).apply{settings.javaScriptEnabled=true;settings.domStorageEnabled=true;addJavascriptInterface(this@master,"K");webViewClient=object:WebViewClient(){override fun onPageStarted(v:WebView?,u:String?,b:Bitmap?){A=false};override fun shouldInterceptRequest(v:WebView?,r:WebResourceRequest?):WebResourceResponse?{val h=r?.url?.host;return if(NET&&r?.url?.scheme !in listOf("file","data")&&!(h!=null&&D.any{it!=""&&(h==it||h.endsWith(".$it"))}))WebResourceResponse(null,null,null)else null}}};f.addView(w);f.addView(b);setContentView(f);v(m);w.loadDataWithBaseURL(null,"""<!DOCTYPE html><title>HTML/App Realizer</title><style>body{margin:0;padding:4px;background:#111;font-family:monospace}div{min-height:40vh;background:#222;color:#eee;border:solid #444;padding:8px;white-space:pre-wrap;margin-bottom:4px;overflow:auto}button{border:0;background:#058;color:#fff;width:100%;height:5vh;font-size:2vh}</style><div id=i contenteditable="plaintext-only" oninput="c.textContent=i.textContent.length"></div><button onclick="var code=i.textContent;document.open();document.write(code);document.close()">Realize (<b id=c>0</b> characters)</button>""","text/html","utf-8",null)};override fun onResume(){super.onResume();if(m==1)v(0)};override fun onDestroy(){super.onDestroy();w.destroy();H.clear()};override fun onKeyDown(k:Int,e:KeyEvent?):Boolean{if(k==24){b.visibility=0;Handler(Looper.getMainLooper()).postDelayed({v(m)},3000);return false};return super.onKeyDown(k,e)};fun v(n:Int){m=n;if(m==3)S("M",3);b.visibility=if(m==0)0 else 8};fun ok()=!s&&(PW==""||A);fun E(){val sv=ScrollView(this);val l=LinearLayout(this).apply{orientation=1;padding=50;setBackgroundColor(-13421773)};sv.addView(l);fun T(e:EditText,f:(String)->Unit)=e.addTextChangedListener(object:TextWatcher{override fun afterTextChanged(s:Editable?)=f(s.toString());override fun beforeTextChanged(s:CharSequence?,x:Int,y:Int,z:Int){};override fun onTextChanged(s:CharSequence?,x:Int,y:Int,z:Int){}});fun U(t:String,c:Int,h:String,v:String,a:(Button)->Unit,x:(String)->Unit){val r=LinearLayout(this);val B=Button(this).apply{text=t;setTextColor(c);setBackgroundColor(0);setOnClickListener{a(this)}};val E=EditText(this).apply{hint=h;setTextColor(-1);setText(v);layoutParams=LinearLayout.LayoutParams(0,-2,1f)};T(E,x);r.addView(B);r.addView(E);l.addView(r)};U("Sandbox: ${if(s)"ON" else "OFF"}",if(s)-16711936 else -65536,"Password",PW,{s=!s;S("S",s);it.text="Sandbox: ${if(s)"ON" else "OFF"}";it.setTextColor(if(s)-16711936 else -65536)}){PW=it;S("W",it);A=false};val tv=TextView(this).apply{setTextColor(-1);textSize=16f;movementMethod=android.text.method.LinkMovementMethod.getInstance();text=SpannableStringBuilder().apply{val m=mapOf("unhide" to 0,"focus" to 1,"open" to 2,"perma" to 3);"unhide/hide settings:till next focus/open/perma".split(Regex("(?<=[a-z])(?=[/:])|(?<=[/:])(?=[a-z])")).forEach{w->if(m.containsKey(w)){val s=length;append(" $w ");setSpan(object:ClickableSpan(){override fun onClick(v:View){v(m[w]!!)};override fun updateDrawState(d:TextPaint){d.color=-1;d.bgColor=-12303292;d.isUnderlineText=false}},s,length,33)}else append(w)}}};l.addView(tv);U("Cut Internet: ${if(NET)"ON" else "OFF"}",if(NET)-65536 else -16711936,"Domain Exceptions",D.joinToString(","),{NET=!NET;S("N",NET);it.text="Cut Internet: ${if(NET)"ON" else "OFF"}";it.setTextColor(if(NET)-65536 else -16711936)}){D.clear();D.addAll(it.split(","));S("D",it)};val n=arrayOf("Whitelist","Graylist","Blacklist");(0..2).forEach{i->l.addView(TextView(this).apply{text=n[i];setTextColor(-1)});val e=EditText(this).apply{setText(L[i].joinToString(","));setTextColor(-1);setBackgroundColor(-12303292)};T(e){L[i].clear();L[i].addAll(it.split(","));S("$i",it)};l.addView(e)};AlertDialog.Builder(this).setView(sv).show()};fun K(i:Int,s:String)=L[i].contains("ALL")||L[i].any{it!=""&&s.contains(it)};fun C(n:String)=try{Class.forName(n)}catch(e:Exception){null};fun R(t:Any?,n:String,j:String,y:Int,cI:Int):String{if(!ok())return "E:SEC";try{val c=if(t is Class<*>)t else t?.javaClass?:return "E:NUL";val a=JSONArray(j);val sig="$n ${c.name}".lowercase();if(y<4&&K(0,sig))return "E:BL";val g=if(y>3||K(1,sig))null else if(K(2,sig))"ALL" else L[2].find{it!=""&&sig.contains(it)}?:if(L[0].isEmpty()&&L[1].isEmpty())"ALL" else null;if(g!=null){val i=(System.currentTimeMillis()%999).toInt();runOnUiThread{AlertDialog.Builder(this).setTitle("REQ:$sig").setPositiveButton("1"){_,_->cb(cI,Ex(t,n,a,y))}.setNeutralButton("OK"){_,_->L[1].add(g);S("1",L[1].joinToString(","));cb(cI,Ex(t,n,a,y))}.setNegativeButton("NO"){_,_->L[0].add(g);S("0",L[0].joinToString(","));cb(cI,"E:BL")}.show()};return "W:$i"};return Ex(t,n,a,y)}catch(e:Exception){return "E:$e"}};fun Ex(t:Any?,n:String,a:JSONArray,y:Int):String{try{val c=if(t is Class<*>)t else t!!.javaClass;val l=a.length();if(y==2)return ret(c.getField(n).get(t));if(y==3){val f=c.getField(n);f.set(t,cv(a.get(0),f.type));return "OK"};if(y==4)return ret(java.lang.reflect.Array.newInstance(c,a.getInt(0)));if(y==5)return ret(Proxy.newProxyInstance(c.classLoader,arrayOf(c)){_,m,r->val g=r?.map{ret(it)}?.joinToString(",")?:"";runOnUiThread{w.evaluateJavascript("window.onL($l,'${m.name}','[$g]')",null)};null});val ms=if(y==1)c.constructors else c.methods;for(m in ms){val pts=m.parameterTypes;if((y==0&&m.name!=n)||pts.size!=l)continue;try{val v=Array(l){i->cv(a.get(i),pts[i])};val r=if(y==1)(m as Constructor<*>).newInstance(*v)else(m as Method).invoke(if(t is Class<*>)null else t,*v);return ret(r)}catch(e:Exception){continue}};return "E:SIG"}catch(e:Exception){return if(e is InvocationTargetException)"E:${e.targetException}"else"E:$e"}};fun cv(o:Any,t:Class<*>)=if(o is String&&o.startsWith("P"))H.getOrNull(o.substring(1).toIntOrNull()?:-1)else if(o is Number)when(t){Int::class.javaPrimitiveType->o.toInt();Long::class.javaPrimitiveType->o.toLong();Float::class.javaPrimitiveType->o.toFloat();Double::class.javaPrimitiveType->o.toDouble();else->o}else if(t==Boolean::class.javaPrimitiveType)o.toString().toBoolean()else o;fun ret(o:Any?)=if(o==null||o is Unit)"V" else if(o is Number||o is String||o is Boolean)"V$o" else{H.add(o);"P${H.size-1}"};fun cb(i:Int,r:String)=if(i>0)w.evaluateJavascript("window.onC($i,'${r.replace("\\","\\\\").replace("'","\\'").replace("\n","\\n")}')",null)else Unit;@JavascriptInterface fun sz()=H.size;@JavascriptInterface fun cls(){H.clear();H.add(this)};@JavascriptInterface fun c(n:String)=try{if(ok()){H.add(Class.forName(n));"P${H.size-1}"}else"E:SEC"}catch(e:Exception){"E:$e"};@JavascriptInterface fun n(c:String,j:String)=R(C(c),"",j,1,0);@JavascriptInterface fun x(p:Int,n:String,j:String)=R(H.getOrNull(p),n,j,0,0);@JavascriptInterface fun u(p:Int,n:String,j:String,cb:Int){runOnUiThread{cb(cb,R(H.getOrNull(p),n,j,0,cb))}};@JavascriptInterface fun g(p:Int,f:String)=R(H.getOrNull(p),f,"[]",2,0);@JavascriptInterface fun s(p:Int,f:String,v:String)=R(H.getOrNull(p),f,"[$v]",3,0);@JavascriptInterface fun a(t:String,l:Int)=R(C(t),"", "[$l]", 4, 0);@JavascriptInterface fun p(t:String,id:Int)=R(C(t),"", "[$id]", 5, 0);@JavascriptInterface fun del(p:Int){if(ok()&&p>0)H[p]=null};@JavascriptInterface fun auth(p:String):Boolean{A=(p==PW);return A}}
